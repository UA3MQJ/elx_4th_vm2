# elx_4th_vm2

Проект по результатам работы проекта https://github.com/UA3MQJ/elx_4th_vm

Совершив некоторый перерыв в работе над проектом, пришел к выводу, что совершенно позабыл все ключевые ньюансы, которые надо понимать по его работе.

В рамках этого проекта хотелось бы повторить изначальный проект - создание vm для forth, но разработать его именно в последовательном варианте. Постепенно добавляя то, что нужно. А не как в изначальном проекте - добавляя все и сразу, непонятно зачем.

# Проект - "восстановление последовательности"

1. Создаем базовый модуль E4vm. Модуль типа структура. Экземпляр структуры с данными будет состоянием vm. А методы - будут реализовывать изменение состояния.
1.1 Базовые свойства форт системы: rs, ds, ip, wp
```
    rs: Structure.Stack.new(), # Стек возвратов
    ds: Structure.Stack.new(), # Стек данных
    ip: 0,                     # Указатель инструкций
    wp: 0,                     # Указатель слова
```
1.2 Адресный интерпретатор. Определяется в функции Next

добавляем память и хранилище базовых слов
```
    mem: %{},                  # память программ
    core: %{},                 # Base instructions
    entries: [],               # Core Word header dictionary
    hereP: 0,                  # Here pointer
```
В памяти храним адреса команд.

В core хранятся указания, как исполнять базовые команды.

Слова в список базовых добавляются через `add_core_word`
```
# первый параметр - слово
# второй параметр - {модуль, функция}
# третий параметр - immediate (признак немедленного исполнения)
E4vm.add_core_word("hello2",  {CoreTest, :hello},   false)

```

Суть интерпретации заключается в переходе по адресу в памяти и в исполнении инструкции, которая там указана.
```
  # Останавливаемся, если адрес 0
  def next(%E4vm{ip: 0} = vm) do
    vm
  end
  def next(vm) do
    # выбираем адрес следующей инструкции
    next_wp = vm.mem[vm.ip]
    # увеличиваем указатель инструкций
    next_ip = vm.ip + 1
    new_vm = %E4vm{vm | ip: next_ip, wp: next_wp}

    # по адресу следующего указателя на слово
    # выбираем адрес инструкции из памяти
    # и по адресу определяем команду с помощью хранилища примитовов
    {m, f} = vm.core[new_vm.mem[next_wp]]

    # выполняем эту команду
    next_new_vm = apply(m, f, [new_vm])

    # повторяем цикл
    next(next_new_vm)
  end
```


